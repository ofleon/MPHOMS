@{
    ViewData["Title"] = "Home Page";
}

<!-- End Navbar -->
<div class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header card-header-primary">
                        <h4 class="card-title ">Open Orders</h4>
                    </div>
                    <div class="card-body">
                        <!--Order List Table-->
                        <div class="table-responsive">
                            <table class="table">
                                <thead class=" text-primary">
                                    <tr>
                                        <th>
                                            Order#
                                        </th>
                                        <th>
                                            Status
                                        </th>
                                        <th>
                                            Payment
                                        </th>
                                        <th>
                                            Customer
                                        </th>
                                        <th>
                                            Store
                                        </th>
                                        <th>
                                        </th>
                                        <th>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                </tbody>
                            </table>
                        </div>
                        <div>
                            <button id="alerts-re-stylized" class="btn btn--primary" type="button">Run Example</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--Modal PopUp Order Detail-->
<div class="modal fade" id="myModal">
    <div class="modal-dialog">
        <div class="modal-content" id="myModalDetail">
        </div>
    </div>
</div>



@section scripts {

    @* Register the WebClientPrint script code generated by DemoPrintCommandsController. *@
    @Html.Raw(ViewData["WCPScript"]);

    <script type="text/javascript">

        $(document).ready(function () {
            loadPrinters();
        });

        /*Show Modal Pop Up with the Order Detail method on Home Controller */
        var ShowOrder = function (OrderId) {

            var url = "/Home/ShowOrder?Id=" + OrderId;

            $("#myModalDetail").load(url, function () {
                $("#myModal").modal("show");
            })
        }

        /*Print Function from detail button with ESC/POS Commands for star TSP100 */
        var LoadCommand = function (OrderId) {
            $.ajax({
                url: '/Home/LoadCommands',
                data: { Id: OrderId },
                method: 'GET'
            }).done(function (data) {
                print(data);
            });
        }
    </script>

    <script type="text/javascript">
        /*SinalR Javascript Connection Client*/
        (async function () {
            var connection = new signalR.HubConnectionBuilder()
                .withUrl("/Hubs/signalOrder")
                .build();

            /*Refresh Function Insert DML*/
            connection.on("refreshOrdersinsert", function (OrderId) {
                loadData()
                loadAlert()
                LoadCommand(OrderId)
            })

            loadData();

            /*Load Toasty Alert with Sound*/
            function loadAlert() {

                'use strict';

                var toasty = new Toasty({
                    transition: "fade",
                    duration: 0, // calculated automatically.
                    enableSounds: true,
                    progressBar: true,
                    autoClose: true,
                    onShow: function (type) {
                        console.log("a toast " + type + " message is shown!");
                    },
                    onHide: function (type) {
                        console.log("the toast " + type + " message is hidden!");
                    }
                });

                toasty.configure({
                    classname: "alert",
                    insertBefore: false,
                    progressBar: true,
                    enableSounds: true
                });

                // register the new transition:
                toasty.transition("scale");

                // and run the first alert message:
                toasty.success("A new order have been placed.", 2500);

            }

            /*Load Data and fill HTML Table*/
            function loadData() {

                var tr = ''

                $.ajax({
                    url: '/Home/GetOrders',
                    method: 'GET',
                    cache: false,
                    success: (result) => {
                        $.each(result, (k, v) => {
                            tr = tr + `<tr>
                        <td>${v.orderId}</dv>
                        <td>${v.status}</td>
                        <td>${v.paymentStatus}</td>
                        <td>${v.email}</td>
                        <td>${v.store}</td>
                        <td class="text-primary">
                           <a href="#" type="button" rel="tooltip" title="View Order" class="btn btn-primary btn-link btn-sm" onclick="ShowOrder(${v.orderId})">
                              <i class="material-icons">assignment</i>
                           </a>
                           <a href="#" type="button" rel="tooltip" title="print" class="btn btn-primary btn-link btn-sm" onclick="LoadCommand(${v.orderId})"  >
                              <i class="material-icons">print</i>
                            </a>
                        </td>
                    </tr>`
                        })

                        $("#tableBody").html(tr)
                    },
                    error: (error) => {
                        console.log(error)
                    }
                })
            }

            /*Print Function from detail button with ESC/POS Commands for star TSP100 */
            var LoadCommand = function (OrderId) {
                $.ajax({
                    url: '/Home/LoadCommands',
                    data: { Id: OrderId },
                    method: 'GET'
                }).done(function (data) {
                    print(data);
                });
            }

            await connection.start();

        })();

    </script>

}


